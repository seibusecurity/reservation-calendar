<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>予約カレンダー</title>
  <style>
    body { font-family: sans-serif; padding: 20px; }
    table { border-collapse: collapse; width: 100%; margin-bottom: 20px; }
    th, td { border: 1px solid #ccc; text-align: center; padding: 10px; }
    .clickable { cursor: pointer; color: blue; }
    .reserved { color: red; }
    .form-container { display: none; margin-bottom: 20px; }
    .form-container input { display: block; margin: 5px 0; }
    .admin-toggle { margin-bottom: 20px; }
    .admin-panel { display: none; border: 1px solid #ccc; padding: 10px; margin-bottom: 20px; }
    .notice { font-size: 0.9em; color: #666; margin-top: 10px; }
    .cancel-btn { margin-left: 10px; color: red; cursor: pointer; }
    @media (max-width: 600px) {
      table, th, td { font-size: 12px; padding: 5px; }
      .form-container input, .admin-toggle input { width: 100%; font-size: 14px; }
      .admin-toggle, .admin-panel, button { font-size: 14px; }
      button { padding: 8px 12px; }
    }
  </style>
</head>
<body>
  <h1>予約カレンダー</h1>

  <div id="reservationInstructions">
    <h2>予約の手順</h2>
    <ol>
      <li>カレンダーで予約したい日付を選択してください（〇の日付）。</li>
      <li>予約フォームにお名前、電話番号、メールアドレスを入力してください。</li>
      <li>「予約を確定する」ボタンをクリックしてください。</li>
      <li>ご入力いただいたメールまたは電話番号に確定連絡をいたします。</li>
    </ol>
  </div>

  <div class="admin-toggle">
    <button onclick="toggleAdminMode()">管理モード切り替え</button>
    <input type="password" id="adminPass" placeholder="管理パスワード（4桁）" maxlength="4">
    <span id="adminStatus">現在: 通常モード</span>
  </div>

  <div id="adminPanel" class="admin-panel">
    <h2>予約一覧</h2>
    <ul id="reservationList"></ul>
  </div>

  <label for="month">月選択:</label>
  <select id="month"></select>
  <select id="year"></select>
  <button onclick="updateCalendar()">表示</button>

  <table id="calendar"></table>

  <div class="form-container" id="reservationForm">
    <h2>予約情報の入力</h2>
    <p id="selectedDateDisplay"></p>
    <input type="text" id="name" placeholder="お名前" required>
    <input type="tel" id="phone" placeholder="電話番号" required>
    <input type="email" id="email" placeholder="メールアドレス" required>
    <button onclick="submitReservation()">予約を確定する</button>
    <p class="notice">※こちらの予約は仮予約となります。予約の確定につきましては登録いただいたメールアドレスもしくは電話番号宛に連絡をいたします。</p>
  </div>

  <script>
    const apiUrl = "https://script.google.com/macros/s/AKfycbwruFJOmA4kNWS6COuz30Fu4sFZK3s_sJzQ1dcQ6iNMu3wGQe4PHwvaGv2db7LTwNHS/exec";
    let reservedDates = [];
    let reservations = [];
    let selectedDate = null;
    let adminMode = false;
    const adminPassword = "1135";

    async function fetchReservations() {
      const response = await fetch(apiUrl);
      const data = await response.json();
      reservations = data;
      reservedDates = data.map(item => item.date);
    }

    function formatDate(date) {
      return date.toISOString().split('T')[0];
    }

    async function generateCalendar(year, month) {
      await fetchReservations();
      const table = document.getElementById("calendar");
      table.innerHTML = "";
      const date = new Date(year, month - 1, 1);
      const daysInMonth = new Date(year, month, 0).getDate();

      let row = table.insertRow();
      for (let i = 0; i < daysInMonth; i++) {
        const currentDate = new Date(year, month - 1, i + 1);
        const formatted = formatDate(currentDate);
        const cell = row.insertCell();

        if (reservedDates.includes(formatted)) {
          cell.innerHTML = `${i + 1}日<br><span class="reserved">×</span>`;
        } else {
          cell.innerHTML = `${i + 1}日<br><span class="clickable">〇</span>`;
        }

        if (adminMode) {
          cell.style.cursor = "pointer";
          cell.onclick = null;
        } else if (!reservedDates.includes(formatted)) {
          cell.onclick = () => {
            selectedDate = formatted;
            document.getElementById("reservationForm").style.display = "block";
            document.getElementById("selectedDateDisplay").innerText = `選択した日付: ${formatted}`;
          };
        }

        if ((i + 1) % 7 === 0) row = table.insertRow();
      }

      if (adminMode) updateReservationList();
    }

    function updateCalendar() {
      const year = parseInt(document.getElementById("year").value);
      const month = parseInt(document.getElementById("month").value);
      document.getElementById("reservationForm").style.display = "none";
      generateCalendar(year, month);
    }

    async function submitReservation() {
      const name = document.getElementById("name").value.trim();
      const phone = document.getElementById("phone").value.trim();
      const email = document.getElementById("email").value.trim();

      if (!name || !phone || !email) {
        alert("全ての項目を入力してください。");
        return; 
      }

      await fetch(apiUrl, {
        method: "POST",
        body: JSON.stringify({ date: selectedDate, name, phone, email }),
        headers: { "Content-Type": "application/json" }
      });

      alert("予約完了しました！");
      document.getElementById("reservationForm").style.display = "none";
      generateCalendar(parseInt(document.getElementById("year").value), parseInt(document.getElementById("month").value));
    }

    function toggleAdminMode() {
      const inputPass = document.getElementById("adminPass").value;
      if (inputPass === adminPassword) {
        adminMode = !adminMode;
        document.getElementById("adminStatus").innerText = adminMode ? "現在: 管理モード" : "現在: 通常モード";
        document.getElementById("adminPanel").style.display = adminMode ? "block" : "none";
        updateCalendar();
      } else {
        alert("パスワードが間違っています。\n管理モードに入れません。");
      }
    }

    function updateReservationList() {
      const list = document.getElementById("reservationList");
      list.innerHTML = "";
      reservations.forEach(res => {
        const item = document.createElement("li");
        item.textContent = `${res.date} - ${res.name}（${res.phone}, ${res.email}）`;
        list.appendChild(item);
      });
    }

    function initSelectors() {
      const monthSelect = document.getElementById("month");
      const yearSelect = document.getElementById("year");
      for (let m = 1; m <= 12; m++) {
        const option = document.createElement("option");
        option.value = m;
        option.text = `${m}月`;
        monthSelect.appendChild(option);
      }
      const thisYear = new Date().getFullYear();
      for (let y = thisYear - 1; y <= thisYear + 2; y++) {
        const option = document.createElement("option");
        option.value = y;
        option.text = `${y}年`;
        yearSelect.appendChild(option);
      }
      monthSelect.value = 4;
      yearSelect.value = 2025;
    }

    initSelectors();
    generateCalendar(2025, 4);
  </script>
</body>
</html>
